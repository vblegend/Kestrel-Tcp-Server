using Light.Transmit.Adapters;
using Light.Transmit.Internals;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Concurrent;
using System.IO.Pipelines;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Threading.Tasks;




namespace Light.Transmit.Network
{
    public class HighPerformanceTcpServer : IPV4Socket
    {
        private Socket listenerSocket;
        private ConcurrentBag<SocketAsyncEventArgs> argsPool;
        private const int BufferSize = 1024;
        private const int MaxConnections = 100;
        private readonly SocketAsyncEventArgs acceptEventArgs;
        public HighPerformanceTcpServer()
        {
            argsPool = new ConcurrentBag<SocketAsyncEventArgs>();

            acceptEventArgs = new SocketAsyncEventArgs();
            acceptEventArgs.Completed += (sender, e) => ProcessAccept(acceptEventArgs);
        }

        public void Start(string ipAddress, int port)
        {
            // 初始化监听Socket
            listenerSocket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
            listenerSocket.Bind(new IPEndPoint(IPAddress.Parse(ipAddress), port));
            listenerSocket.Listen(100);
            Console.WriteLine("Server started. Listening for connections...");
            // 初始化对象池
            for (int i = 0; i < MaxConnections; i++)
            {
                var readWriteArgs = new SocketAsyncEventArgs();
                readWriteArgs.Completed += IO_Completed;
                readWriteArgs.SetBuffer(new byte[BufferSize], 0, BufferSize);
                argsPool.Add(readWriteArgs);
            }

            // 开始接受连接
            StartAccept(acceptEventArgs);
        }

        private void StartAccept(SocketAsyncEventArgs acceptArgs)
        { 
            // 重置
            acceptArgs.AcceptSocket = null;
            // 异步接受连接
            if (!listenerSocket.AcceptAsync(acceptArgs)) ProcessAccept(acceptArgs);
        }


        private void ProcessAccept(SocketAsyncEventArgs acceptArgs)
        {
            Socket clientSocket = acceptArgs.AcceptSocket;
            if (clientSocket != null && argsPool.TryTake(out var readWriteArgs))
            {
                Console.WriteLine("Join");
                readWriteArgs.AcceptSocket = clientSocket;
                readWriteArgs.UserToken = 12345667;
                //
                // OnConnection()
                //
                if (!clientSocket.ReceiveAsync(readWriteArgs)) ProcessReceive(readWriteArgs);
            }
            // 继续接受下一个连接
            StartAccept(acceptArgs);
        }

        private void IO_Completed(object sender, SocketAsyncEventArgs e)
        {
            switch (e.LastOperation)
            {
                case SocketAsyncOperation.Receive:
                    ProcessReceive(e);
                    break;
                case SocketAsyncOperation.Send:
                    ProcessSend(e);
                    break;
            }
        }

        private void ProcessReceive(SocketAsyncEventArgs eventArgs)
        {
            Socket clientSocket = eventArgs.AcceptSocket;

            if (eventArgs.BytesTransferred > 0 && eventArgs.SocketError == SocketError.Success)
            {
                // 接收数据
                string receivedText = Encoding.UTF8.GetString(eventArgs.Buffer, eventArgs.Offset, eventArgs.BytesTransferred);
                Console.WriteLine($"Received: {receivedText}");
                if (!clientSocket.ReceiveAsync(eventArgs)) ProcessReceive(eventArgs);
                // 回写数据
                //byte[] responseData = Encoding.UTF8.GetBytes("Echo: " + receivedText);
                //eventArgs.SetBuffer(responseData, 0, responseData.Length);
                //if (!clientSocket.SendAsync(eventArgs)) ProcessSend(eventArgs);

                send100000(clientSocket);






            }
            else
            {
                // 关闭连接
                CloseClientSocket(eventArgs);
            }
        }


        public async Task send100000(Socket clientSocket)
        {
            byte[] responseData = Encoding.UTF8.GetBytes("Echo: send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000");

            for (int i = 0; i < 100000; i++)
            {
                await SendData(clientSocket, responseData);
            }
        }



        public async Task SendData(Socket clientSocket, byte[] data)
        {
            var tcs = new TaskCompletionSource();
            var sendArgs = new SocketAsyncEventArgs();
            sendArgs.AcceptSocket = clientSocket;
            sendArgs.UserToken = tcs;
            sendArgs.SetBuffer(data, 0, data.Length);
            sendArgs.Completed += IO_Completed;
            if (!clientSocket.SendAsync(sendArgs))
            {
                // 如果 SendAsync 立即完成，调用 SendCompleted 处理数据发送
                ProcessSend(sendArgs);
            }
            await tcs.Task;
        }


        int cpiu = 0;
        private void ProcessSend(SocketAsyncEventArgs e)
        {
            Socket clientSocket = e.AcceptSocket;
            TaskCompletionSource tcs = e.UserToken as TaskCompletionSource;
            if (e.SocketError == SocketError.Success)
            {
                var length = e.Count - e.Offset;
                if (e.BytesTransferred != length)
                {
                    // 测试过程中没发现有没发送完成的情况
                    Console.WriteLine("未发送完成");
                }
                cpiu++;
                Console.WriteLine(cpiu);
                tcs.SetResult();
                // 继续接收数据
                //if (!clientSocket.ReceiveAsync(e)) ProcessReceive(e);
            }
            else
            {
                tcs.SetException(new Exception("连接已关闭"));
                // 关闭连接
                CloseClientSocket(e);
            }
        }


        private void CloseClientSocket(SocketAsyncEventArgs e)
        {
            Socket clientSocket = e.AcceptSocket;

            try
            {
                clientSocket.Shutdown(SocketShutdown.Both);
            }
            catch
            {
                // 忽略异常
            }

            clientSocket.Close();
            e.UserToken = null;
            Console.WriteLine("Client disconnected");
            // 将 SocketAsyncEventArgs 放回对象池
            argsPool.Add(e);
        }
    }
}
