using Light.Transmit.Adapters;
using Light.Transmit.Internals;
using Light.Transmit.Pools;
using System;
using System.Buffers;
using System.Collections.Concurrent;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;




namespace Light.Transmit.Network
{
    public class HighPerformanceTcpServer : IPV4Socket, IPacketServer
    {
        private ConcurrentBag<SocketAsyncEventArgs> argsPool;
        private const int BufferSize = 1024;
        private const int MaxConnections = 100;
        private readonly SocketAsyncEventArgs acceptEventArgs;
        private readonly ObjectPool<SocketAsyncEventArgs> writePool;
        private readonly ObjectPool<SocketAsyncEventArgs> readArgsPool;
        private ServerHandlerAdapter handlerAdapter = null;
        private Int32 receiveBufferSize = 8192;
        private Int32 sendBufferSize = 8192;


        private SocketAsyncEventArgs CreateSocketAsyncEventArgs()
        {
            var args = new SocketAsyncEventArgs();
            args.Completed += IO_Completed;
            return args;
        }

        private SocketAsyncEventArgs CreateReadEventArgs()
        {
            var args = new SocketAsyncEventArgs();
            args.SetBuffer(new byte[8192000], 0, 8192000);
            args.Completed += IO_Completed;
            return args;
        }


        public void SetAdapter(ServerHandlerAdapter handlerAdapter)
        {
            this.handlerAdapter = handlerAdapter;
        }
        public HighPerformanceTcpServer()
        {
            argsPool = new ConcurrentBag<SocketAsyncEventArgs>();
            writePool = new ObjectPool<SocketAsyncEventArgs>(this.CreateSocketAsyncEventArgs, 1024);
            readArgsPool = new ObjectPool<SocketAsyncEventArgs>(this.CreateReadEventArgs, 1024);
            acceptEventArgs = new SocketAsyncEventArgs();
            acceptEventArgs.Completed += (sender, e) => ProcessAccept(acceptEventArgs);
        }



        private void StartAccept(SocketAsyncEventArgs acceptArgs)
        {
            // 重置
            acceptArgs.AcceptSocket = null;
            // 异步接受连接
            if (!socket.AcceptAsync(acceptArgs)) ProcessAccept(acceptArgs);
        }


        private void ProcessAccept(SocketAsyncEventArgs acceptArgs)
        {
            Socket clientSocket = acceptArgs.AcceptSocket;
            if (clientSocket != null)
            {
                SocketAsyncEventArgs readArgs = readArgsPool.Get();
                Console.WriteLine("Join");
                readArgs.AcceptSocket = clientSocket;
                clientSocket.SetSocketOption(SocketOptionLevel.Tcp, SocketOptionName.NoDelay, true);
                clientSocket.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.SendBuffer, sendBufferSize);
                clientSocket.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.ReceiveBuffer, receiveBufferSize);

                var session = new InternalNetSession();
                //session.ConnectionId = Interlocked.Increment(ref ConnectionIdSource);
                session.ConnectTime = TimeService.Default.LocalNow();
                //session.Init(networkStream, sendBufferSize);
                session.Init(clientSocket);
                readArgs.UserToken = session;
                //
                // OnConnection()
                //
                if (!clientSocket.ReceiveAsync(readArgs))
                    ProcessReceive(readArgs);
            }
            // 继续接受下一个连接
            StartAccept(acceptArgs);
        }

        private void IO_Completed(object sender, SocketAsyncEventArgs e)
        {
            switch (e.LastOperation)
            {
                case SocketAsyncOperation.Receive:
                    ProcessReceive(e);
                    break;
                case SocketAsyncOperation.Send:
                    ProcessSend(e);
                    break;
            }
        }
        private unsafe void ProcessReceive(SocketAsyncEventArgs eventArgs)
        {
            Socket clientSocket = eventArgs.AcceptSocket;
            InternalNetSession session = eventArgs.UserToken as InternalNetSession;

            do
            {
                try
                {
                    if (eventArgs.BytesTransferred > 0 && eventArgs.SocketError == SocketError.Success)
                    {
                        var length = eventArgs.Offset + eventArgs.BytesTransferred;
                        // 使用正确的参数来构造 ReadOnlySequence，确保不丢失粘包部分
                        ReadOnlySequence<byte> readOnlyMemory = new ReadOnlySequence<byte>(eventArgs.Buffer, 0, length);

                        // 处理数据包（handlerAdapter 会处理粘包和返回有效字节的数量）
                        var result = handlerAdapter.OnPacket(session, readOnlyMemory);

                        if (result.ReadLength < eventArgs.Buffer.Length)
                        {
                            // 处理剩余数据，将有效数据移到缓冲区的前面
                            var buffer = eventArgs.MemoryBuffer;
                            var remaining = length - result.ReadLength;

                            // 将剩余数据复制到缓冲区的前面
                            var source = buffer.Slice(result.ReadLength, remaining);
                            var destination = buffer.Slice(0, remaining);
                            source.CopyTo(destination);

                            // 更新 eventArgs 的缓冲区和偏移量
                            eventArgs.SetBuffer(remaining, eventArgs.Buffer.Length - remaining);  // 设置剩余数据长度
                        }
                        else
                        {
                            // 如果已读取完全部数据，则重置缓冲区
                            eventArgs.SetBuffer(0, eventArgs.Buffer.Length);
                        }
                    }
                    else
                    {
                        // 连接关闭或发生错误，关闭连接
                        CloseClientSocket(eventArgs);
                        readArgsPool.Return(eventArgs);
                        break;
                    }
                }
                catch (Exception ex)
                {
                    // 处理异常
                    Console.WriteLine($"Error processing receive: {ex.Message}");
                    CloseClientSocket(eventArgs);
                    readArgsPool.Return(eventArgs);
                    break;
                }

            } while (!clientSocket.ReceiveAsync(eventArgs));  // 继续接收数据
        }




        public async Task send100000(Socket clientSocket)
        {
            byte[] responseData = Encoding.UTF8.GetBytes("Echo: send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000send100000");

            for (int i = 0; i < 100000; i++)
            {
                await SendData(clientSocket, i, responseData);
            }
        }



        public async Task SendData(Socket clientSocket, Int32 index, byte[] data)
        {
            var sendArgs = writePool.Get();
            var tcs = new TaskCompletionSource();
            sendArgs.AcceptSocket = clientSocket;
            sendArgs.UserToken = tcs;
            sendArgs.SetBuffer(data, 0, data.Length);
            if (!clientSocket.SendAsync(sendArgs))
            {
                // 如果 SendAsync 立即完成，调用 SendCompleted 处理数据发送
                ProcessSend(sendArgs);
            }
            await tcs.Task;
        }


        int cpiu = 0;


        private void ProcessSend(SocketAsyncEventArgs e)
        {
            Socket clientSocket = e.AcceptSocket;
            TaskCompletionSource tcs = e.UserToken as TaskCompletionSource;
            if (e.SocketError == SocketError.Success)
            {
                var length = e.Count - e.Offset;
                if (e.BytesTransferred != length)
                {
                    // 测试过程中没发现有没发送完成的情况
                    Console.WriteLine("未发送完成, 测试过程中没发现有没发送完成的情况");
                }
                cpiu++;
                Console.WriteLine(cpiu);
                tcs.SetResult();
            }
            else
            {
                // 关闭连接
                CloseClientSocket(e);
                tcs.SetException(new Exception("连接已关闭"));
            }
            e.AcceptSocket = null;
            e.UserToken = null;
            writePool.Return(e);
        }


        private void CloseClientSocket(SocketAsyncEventArgs e)
        {
            Socket clientSocket = e.AcceptSocket;

            try
            {
                clientSocket.Shutdown(SocketShutdown.Both);
            }
            catch
            {
                // 忽略异常
            }

            clientSocket.Close();
            e.UserToken = null;
            Console.WriteLine("Client disconnected");
            // 将 SocketAsyncEventArgs 放回对象池
            argsPool.Add(e);
        }

        public void Listen(Uri uri)
        {
            if (uri == null) throw new Exception("参数不能为空");
            if (uri.Scheme != "tcp") throw new Exception("不支持的协议");
            var querys = uri.ParseQuery();
            if (querys.TryGetValue("readBuffer", out var readBufferSize))
            {
                this.ReceiveBufferSize = Int32.Parse(readBufferSize);
            }
            if (querys.TryGetValue("writeBuffer", out var writeBufferSize))
            {
                this.SendBufferSize = Int32.Parse(writeBufferSize);
            }
            Listen(IPAddress.Parse(uri.Host), uri.Port);
        }

        public void Listen(IPAddress ipAddress, int port)
        {
            // 初始化监听Socket

            socket.Bind(new IPEndPoint(ipAddress, port));
            socket.Listen(100);
            Console.WriteLine("Server started. Listening for connections...");
            // 初始化对象池
            for (int i = 0; i < MaxConnections; i++)
            {
                var readWriteArgs = new SocketAsyncEventArgs();
                readWriteArgs.Completed += IO_Completed;
                readWriteArgs.SetBuffer(new byte[BufferSize], 0, BufferSize);
                argsPool.Add(readWriteArgs);
            }

            // 开始接受连接
            StartAccept(acceptEventArgs);
        }

        public Task StopAsync()
        {
            return Task.CompletedTask;
        }


        public int MaximumConnectionLimit
        {
            get
            {
                return 0;
            }
            set
            {
       
            }
        }

        public int CurrentConnections => 0;


        public override int ReceiveBufferSize
        {
            get
            {
                return receiveBufferSize;
            }
            set
            {
                receiveBufferSize = value;
                base.ReceiveBufferSize = value;
            }
        }

        public override int SendBufferSize
        {
            get
            {
                return sendBufferSize;
            }
            set
            {
                sendBufferSize = value;
                base.SendBufferSize = value;
            }
        }



    }
}
